{% extends 'patient/base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block body %}

<!-- Include Bootstrap CSS and JavaScript directly -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<style>
    /* styles.css */
.card {
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.card-title {
    color: #333;
}

.form-control {
    border-radius: 5px;
}

.btn-primary {
    background-color: #007BFF;
    border: none;
}

.btn-primary:hover {
    background-color: #0056b3;
}

</style>

<div id="content-wrapper">

    <div class="container-fluid">

        <!-- Add export buttons with top margin -->
        
        <!-- Icon Cards-->
        <div class="row justify-content-center mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title">Create Appointment</h2>
                        <form method="post" class="mt-3" id="add-product-form" novalidate>
                            {% csrf_token %}
                        
                            <!-- Date Input -->
                            <div class="form-group">
                                <label for="id_date">Date</label>
                                <input type="date" id="id_date" name="date" class="form-control form-control-lg" placeholder="YYYY-MM-DD">
                            </div>
                        
                            <!-- Time Input -->
                            <div class="form-group">
                                <label for="id_time">Time</label>
                                <input type="time" id="id_time" name="time" class="form-control form-control-lg" placeholder="HH:MM">
                            </div>
                        
                            <!-- Patient Input (Readonly) -->
                            <div class="form-group">
                                <label for="id_patient">Patient</label>
                                <input type="text" id="id_patient" name="patient" class="form-control form-control-lg" readonly value="{{ request.user.username }}">
                            </div>
                            
                        
                            <!-- Specialization Select -->
                            <div class="form-group">
                                <label for="id_specialization">Specialization</label>
                                <select id="id_specialization" name="id_specialization" class="form-control form-control-lg id_specialization">
                                    <option value="Dermatologists">Dermatologists</option>
                                    <option value="Allergists">Allergists</option>
                                    <option value="Diabetologists">Diabetologists</option>
                                    <option value="Infectious Disease Specialists">Infectious Disease Specialists</option>
                                    <option value="Neurologists">Neurologists</option>
                                    <option value="Gastroenterologists">Gastroenterologists</option>
                                    <option value="Urologists">Urologists</option>
                                    {% comment %} <option value="HIV Specialists">HIV Specialists</option> {% endcomment %}


                                    <!-- Add other specialization options here -->
                                </select>
                            </div>
                        
                            <!-- Doctor Select -->
                            <div class="form-group">
                                <label for="id_doctor">Doctor</label>
                                <select id="id_doctor" name="id_doctor" class="form-control form-control-lg id_doctor">
                                    <!-- Doctors will be populated dynamically using JavaScript -->
                                </select>
                            </div>
                        
                            <!-- Submit Button -->
                            <button type="submit" class="btn btn-primary">Create Appointment</button>
                        </form>
                        
                    </div>
                </div>
            </div>
        </div>
        {% comment %} <div id="popup" class="popup">
            <span class="popup-content" id="popup-content">Appointment created successfully!</span>
        </div> {% endcomment %}
        <script>
            // Function to show the popup
            function showPopup() {
                var popup = document.getElementById("popup");
                popup.style.display = "block";
                setTimeout(function() {
                    popup.style.display = "none";
                }, 3000); // Hide the popup after 3 seconds (adjust the timing as needed)
            }
            
            // Check if the success_message variable is set and display the popup accordingly
            {% if success_message %}
                showPopup();
            {% endif %}



            $('#id_specialization').on('change', function () {
                var categoryId = $(this).val();
                if (categoryId) {
                    $.ajax({
                        url: '{% url "get_subcategories" %}', // Use the URL pattern name
                        data: {
                            'category_id': categoryId
                        },
                        success: function (data) {
                            var subcategorySelect = $('#id_doctor');
                            subcategorySelect.empty(); // Clear previous options
                            subcategorySelect.append($('<option>', {
                                value: '',
                                text: 'Select Doctor'
                            }));
                            $.each(data.subcategories, function (index, subcategory) {
                                subcategorySelect.append($('<option>', {
                                    value: subcategory.id,
                                    text: subcategory.name
                                }));
                            });
                        }
                    });
                } else {
                    $('#subcategory').html('<option value="">Select a category first</option>');
                }
            });




            const updateProductForm = document.getElementById("add-product-form");

						updateProductForm.addEventListener("submit", function (e) {
							e.preventDefault();

							// Collect the updated data from the form
							const formData = new FormData(updateProductForm);

							// Extract the product_id from the form or data attributes
							const productId = document.getElementById("id_doctor").value;

							// Define the base URL for the AJAX request

							// Send an AJAX request to the dynamically determined URL
							$.ajax({
								url: `/book_appointment/${productId}/`,
								method: "POST",
								data: formData,
								processData: false,
								contentType: false,
								success: function (data) {
									// Handle success (e.g., show a success message)
									console.log(data.message);
										// Redirect to the "add_product" URL if productId is null
                                        window.location.href = "/appointment_success/"; // R
								},
								error: function (error) {
									// Handle errors (e.g., display an error message)
									console.error("Error updating product:", error);
								},
							});
						});
            </script>
            
                    
    </div>
</div>

{% endblock %}
